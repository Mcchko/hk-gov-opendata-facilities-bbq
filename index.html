<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>香港燒烤地點地圖</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet Marker Cluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet Marker Cluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #map {
            flex: 1;
            min-height: 320px;
        }

        .sidebar {
            width: 350px;
            background-color: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 0.3rem;
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .site-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .site-item {
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f9f9f9;
        }

        .site-item:hover {
            background-color: #eef7ff;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            border-color: #3498db;
        }

        .site-item.active {
            background-color: #e1f0ff;
            border-color: #2980b9;
            border-left: 4px solid #2980b9;
        }

        .site-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }

        .site-district {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }

        .site-facilities {
            font-size: 0.85rem;
            color: #27ae60;
            margin-bottom: 0.5rem;
            margin-left: 0.5rem;
        }

        .controls {
            padding: 1rem;
            background-color: #f8f9fa;
            border-top: 1px solid #ddd;
        }

        .filter-control label {
            display: block;
            margin-bottom: 0.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .filter-control select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .stats {
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
            padding: 0.5rem;
            background-color: #f1f8ff;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            #map {
                max-height: 320px;
            }

            .content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                min-height: 40%;
                /* height: 40%; */
            }
        }

        .popup-content {
            max-width: 300px;
        }

        .popup-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .popup-detail {
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .popup-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        .legend h4 {
            margin: 0 0 10px;
            text-align: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h3>香港燒烤地點地圖</h3>
            <div class="subtitle">全香港公共燒烤地點互動地圖</div>
        </header>

        <div class="content">
            <div id="map"></div>

            <div class="sidebar">
                <div class="sidebar-header">
                    燒烤地點 (42個位置)
                </div>

                <div class="controls">
                    <div class="filter-control">
                        <label for="districtFilter">按地區篩選:</label>
                        <select id="districtFilter">
                            <option value="all">所有地區</option>
                        </select>
                    </div>
                </div>

                <div class="sidebar-content">
                    <div class="site-list" id="siteList">
                        <!-- 地點列表將由 JavaScript 填充 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // BBQ 地點數據
        var allMarkers = [];
        var bbqData = []; // 先初始化為空數組

        // 初始化地圖
        const map = L.map('map').setView([22.3193, 114.1694], 11);

        // 從康文署API獲取燒烤地點數據
        async function fetchBBQData() {
            try {
                const response = await fetch(`${"https://cors-anywhere.herokuapp.com/"}https://www.lcsd.gov.hk/datagovhk/facility/facility-bbqs.json`);
                if (!response.ok) {
                    throw new Error(`HTTP錯誤! 狀態碼: ${response.status}`);
                }
                const data = await response.json();
                bbqData = data; // 將獲取到的數據賦值給bbqData
                console.log(`成功獲取 ${bbqData.length} 個燒烤地點`);
                initializeApp(); // 數據加載完成後初始化應用
            } catch (error) {
                console.error('獲取燒烤地點數據時發生錯誤:', error);
                // 顯示錯誤訊息給用戶
                alert('無法加載燒烤地點數據，請稍後再試。');
                // 可選：使用默認數據或顯示錯誤狀態
                window.open("https://cors-anywhere.herokuapp.com/", "_href");
            }
        }

        // 應用初始化函數
        function initializeApp() {
            // 添加 OpenStreetMap 圖層
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> 貢獻者'
            }).addTo(map);

            // 地區顏色標記
            const districtColors = {
                '元朗': '#e74c3c',
                '屯門': '#3498db',
                '西貢': '#2ecc71',
                '沙田': '#9b59b6',
                '南區': '#1abc9c',
                '荃灣': '#f39c12',
                '黃大仙': '#d35400',
                '離島': '#34495e',
                '大埔': '#16a085'
            };

            // 創建標記聚類群組
            const markers = L.markerClusterGroup();

            // 儲存所有標記以便篩選
            let currentFilter = 'all';

            // 處理數據並在地圖上添加標記
            bbqData.forEach((site, index) => {
                const lat = dmsToDecimal(site.Latitude);
                const lng = dmsToDecimal(site.Longitude);

                // 跳過無效座標
                if (lat === null || lng === null) return;

                // 獲取此地區的顏色
                const color = districtColors[site.District_cn] || '#7f8c8d';

                // 創建自定義標記圖標
                const markerIcon = L.divIcon({
                    html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                    className: 'custom-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                // 創建標記
                const marker = L.marker([lat, lng], { icon: markerIcon })
                    .bindPopup(createPopupContent(site));

                // 儲存對地點數據的引用
                marker.siteData = site;
                marker.siteIndex = index;

                // 添加到聚類群組
                markers.addLayer(marker);
                allMarkers.push(marker);

                // 創建側邊欄列表項目
                createSidebarItem(site, index);
            });

            // 將標記添加到地圖
            map.addLayer(markers);

            // 填充地區篩選下拉選單
            const districts = [...new Set(bbqData.map(site => site.District_cn))].sort();
            const districtFilter = document.getElementById('districtFilter');

            // 清空現有選項（保留"所有地區"）
            while (districtFilter.options.length > 1) {
                districtFilter.remove(1);
            }

            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtFilter.appendChild(option);
            });

            // 添加篩選事件監聽器
            districtFilter.addEventListener('change', function () {
                currentFilter = this.value;
                filterMarkersAndList();
            });

            // 更新側邊欄標題
            document.querySelector('.sidebar-header').textContent = `燒烤地點 (${bbqData.length}個位置)`;

            // 初始化顯示所有標記
            filterMarkersAndList();

            // 添加圖例
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function () {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = '<h4>地區</h4>';

                Object.keys(districtColors).forEach(district => {
                    div.innerHTML += `
<div class="legend-item">
<div class="legend-color" style="background-color: ${districtColors[district]}"></div>
<span>${district}</span>
</div>
`;
                });

                return div;
            };
            legend.addTo(map);

            // 記錄數據統計
            console.log(`加載了 ${bbqData.length} 個燒烤地點`);
            console.log(`地區: ${districts.join(', ')}`);

            // 篩選標記和列表項目的函數
            function filterMarkersAndList() {
                const siteItems = document.querySelectorAll('.site-item');
                let visibleCount = 0;

                // 清除所有標記
                markers.clearLayers();

                // 添加篩選後的標記
                allMarkers.forEach(marker => {
                    const showMarker = currentFilter === 'all' || marker.siteData.District_cn === currentFilter;

                    if (showMarker) {
                        markers.addLayer(marker);
                        visibleCount++;
                    }
                });

                // 更新列表項目
                siteItems.forEach(item => {
                    const showItem = currentFilter === 'all' || item.dataset.district === currentFilter;
                    item.style.display = showItem ? 'flex' : 'none';
                });

                // 更新側邊欄標題
                document.querySelector('.sidebar-header').textContent =
                    currentFilter === 'all'
                        ? `燒烤地點 (${visibleCount}個位置)`
                        : `${currentFilter}區 (${visibleCount}個位置)`;
            }
        }

        // 將 DMS（度-分-秒）轉換為十進制度的函數
        function dmsToDecimal(dms) {
            // 處理無效座標
            if (!dms || dms.trim() === "") return null;

            // 處理最後一個數據點中的無效座標
            if (dms === "113-99-128") {
                // 修正明顯的拼寫錯誤：99分鐘不可能，可能意為59
                dms = "113-59-28";
            }

            const parts = dms.split('-');
            if (parts.length !== 3) return null;

            const degrees = parseFloat(parts[0]);
            const minutes = parseFloat(parts[1]);
            const seconds = parseFloat(parts[2]);

            if (isNaN(degrees) || isNaN(minutes) || isNaN(seconds)) return null;

            return degrees + (minutes / 60) + (seconds / 3600);
        }

        // 創建彈出視窗內容的函數
        function createPopupContent(site) {
            // 從設施文本中提取燒烤爐數量
            const facilitiesText = site.Facilities_cn || '';
            const bbqMatch = facilitiesText.match(/\d+/);
            const bbqCount = bbqMatch ? bbqMatch[0] : '不適用';

            return `
<div class="popup-content">
<div class="popup-title">${site.Name_cn}</div>
<div class="popup-detail"><span class="popup-label">地區:</span> ${site.District_cn}</div>
<div class="popup-detail"><span class="popup-label">地址:</span> ${site.Address_cn}</div>
<div class="popup-detail"><span class="popup-label">燒烤爐數量:</span> ${bbqCount}</div>
<div class="popup-detail"><span class="popup-label">開放時間:</span> ${site.Opening_hours_cn.replace('<strong>', '').replace('</strong>', '')}</div>
${site.Phone ? `<div class="popup-detail"><span class="popup-label">電話:</span> ${site.Phone}</div>` : ''}
${site.Ancillary_facilities_cn ? `<div class="popup-detail"><span class="popup-label">設施:</span> ${site.Ancillary_facilities_cn.replace(/<[^>]*>/g, '')}</div>` : ''}
</div>
`;
        }

        // 創建側邊欄列表項目的函數
        function createSidebarItem(site, index) {
            const siteList = document.getElementById('siteList');

            const item = document.createElement('div');
            item.className = 'site-item';
            item.dataset.index = index;
            item.dataset.district = site.District_cn;

            item.innerHTML = `
                <div class="d-flex flex-column">
                    <div class="site-name">${site.Name_cn}</div>
                    <div class="site-district">${site.District_cn}區</div>
                    <div class="site-facilities">${site.Facilities_b5}</div>
                </div>
            `;

            // 添加點擊事件以顯示標記並打開彈出視窗
            item.addEventListener('click', function () {
                // 從所有項目中移除 active 類
                document.querySelectorAll('.site-item').forEach(el => {
                    el.classList.remove('active');
                });

                // 為點擊的項目添加 active 類
                this.classList.add('active');

                // 尋找對應的標記
                const marker = allMarkers.find(m => m.siteIndex === index);
                if (marker) {
                    // 縮放到標記
                    map.setView(marker.getLatLng(), 15);

                    // 打開彈出視窗
                    marker.openPopup();
                }
            });

            siteList.appendChild(item);
        }

        // 頁面加載時獲取數據
        document.addEventListener('DOMContentLoaded', fetchBBQData);
    </script>
</body>

</html>
